<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CSV ‚Üí Exam Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Baloo+2:wght@600;700;800&display=swap" rel="stylesheet"/>
<style>
:root{
  --sky:#4BB8F5; --grass:#52C16A; --coral:#FF6B6B;
  --purple:#9B72CF; --orange:#FF9740; --sun:#FFD234;
  --navy:#1a2744; --ink:#1a2744; --paper:#FFFDF5;
  --card:#fff; --line:#E8E3D9; --muted:#7a8096; --r:14px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--paper);color:var(--ink);font-family:'Nunito',sans-serif;font-size:14.5px;line-height:1.55;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:
  radial-gradient(circle at 10% 18%,#FFD23412 0 45px,transparent 45px),
  radial-gradient(circle at 88% 14%,#4BB8F512 0 60px,transparent 60px),
  radial-gradient(circle at 55% 82%,#FF6B6B10 0 80px,transparent 80px),
  radial-gradient(circle at 4% 72%,#52C16A10 0 50px,transparent 50px);
  pointer-events:none;z-index:0;}
.page{max-width:1120px;margin:0 auto;padding:20px 16px 110px;position:relative;z-index:1}

/* Builder panel */
.builder{background:#fff;border:1.5px solid var(--line);border-radius:18px;padding:14px 14px 12px;margin-bottom:14px;}
.builder h1{font-family:'Baloo 2',sans-serif;font-size:18px;margin-bottom:6px;color:var(--navy)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
.ta{width:100%;min-height:130px;border:1.5px solid var(--line);border-radius:12px;padding:10px 12px;font:600 13px 'Nunito',sans-serif;outline:none;background:#fafafa}
.ta:focus{background:#fff;border-color:var(--purple)}
.file{border:1.5px solid var(--line);border-radius:12px;padding:8px 10px;background:#fff}
.small{font-size:12.5px;color:var(--muted)}
.btn{border:2px solid transparent;border-radius:12px;padding:8px 14px;cursor:pointer;font:800 13px 'Nunito',sans-serif;transition:all .18s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:linear-gradient(135deg,#4BB8F5,#1a8cd8);color:#fff}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 14px #4BB8F540}
.btn-ghost{background:#fff;color:var(--navy);border-color:var(--line)}
.btn-ghost:hover{border-color:var(--purple);color:var(--purple)}
.btn-warn{background:#fff;color:var(--coral);border-color:#FF6B6B60}
.btn-warn:hover{background:#FF6B6B10}

/* Exam header */
.exam-header{
  background:linear-gradient(135deg,#1a2744 0%,#2d3f70 60%,#3d2060 100%);
  border-radius:24px;padding:22px 24px;color:#fff;display:flex;gap:18px;
  align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:16px;
  box-shadow:0 8px 32px #1a274440;position:relative;overflow:hidden;
}
.exam-header::before{content:'';position:absolute;right:-40px;top:-40px;width:200px;height:200px;
  background:radial-gradient(circle,#FFD23430 0%,transparent 70%);border-radius:50%;}
.exam-header::after{content:'üßÆ';font-size:76px;position:absolute;right:22px;bottom:-12px;opacity:.14;}
.h-title{font-family:'Baloo 2',sans-serif;font-size:24px;font-weight:900;margin-bottom:4px;line-height:1.2}
.h-sub{font-size:13px;opacity:.82;margin-bottom:10px}
.badge-row{display:flex;gap:7px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:4px;background:#ffffff20;border:1px solid #ffffff35;border-radius:999px;padding:3px 11px;font-size:11.5px;font-weight:800;}
.name-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;width:100%}
.name-row input{background:#ffffff15;border:1px solid #ffffff35;border-radius:10px;padding:7px 12px;color:#fff;font:700 13px 'Nunito',sans-serif;min-width:175px;outline:none;}
.name-row input::placeholder{opacity:.55}
.name-row label{font-size:13px;opacity:.85;font-weight:800}
.info-boxes{display:flex;gap:10px;flex-wrap:wrap}
.info-box{background:#ffffff18;border:1px solid #ffffff30;border-radius:14px;padding:10px 14px;text-align:center;min-width:92px}
.info-box .val{font-family:'Baloo 2',sans-serif;font-size:22px;font-weight:900;color:#FFD234;display:block}
.info-box .lbl{font-size:10.5px;opacity:.78;text-transform:uppercase;letter-spacing:.5px}

/* Controls */
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px;align-items:center;justify-content:space-between}
.pb-wrap{background:#fff;border:1.5px solid var(--line);border-radius:999px;height:11px;overflow:hidden;min-width:240px;margin-bottom:4px}
.pb{height:100%;background:linear-gradient(90deg,#4BB8F5,#9B72CF);border-radius:999px;width:0%;transition:width .4s}
.pb-lbl{font-size:11.5px;color:var(--muted)}

/* Sections & cards */
.section{margin:18px 0 0}
.sh{display:flex;align-items:center;gap:12px;margin-bottom:10px;padding:12px 16px;border-radius:14px;
  font-family:'Baloo 2',sans-serif;font-size:16px;font-weight:900;}
.sh-mc{background:linear-gradient(90deg,#4BB8F515,transparent);border-left:4px solid #4BB8F5}
.sh-tf{background:linear-gradient(90deg,#52C16A15,transparent);border-left:4px solid #52C16A}
.sh-fi{background:linear-gradient(90deg,#9B72CF15,transparent);border-left:4px solid #9B72CF}
.sh-op{background:linear-gradient(90deg,#FF6B6B15,transparent);border-left:4px solid #FF6B6B}
.sh .tag{margin-left:auto;font-size:11.5px;font-weight:800;background:#fff;border:1px solid var(--line);
  border-radius:999px;padding:3px 11px;color:var(--muted);}
.hint{color:var(--muted);font-size:12.5px;margin:-6px 0 10px 4px;font-style:italic}
.grid{display:grid;gap:10px;grid-template-columns:1fr}
@media(min-width:700px){.grid.two{grid-template-columns:1fr 1fr}}
@media(min-width:1000px){.grid.three{grid-template-columns:1fr 1fr 1fr}}

.q{background:var(--card);border:1.5px solid var(--line);border-radius:var(--r);padding:12px 13px;
  transition:box-shadow .18s,border-color .18s;position:relative;overflow:hidden;}
.q:hover{box-shadow:0 3px 14px #00000010;border-color:#ccc}
.q::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
.q.mc::before{background:#4BB8F5}
.q.tf::before{background:#52C16A}
.q.fi::before{background:#9B72CF}
.q.open::before{background:#FF6B6B}

.q.correct-card{border-color:#52C16A;background:#f0fff4}
.q.wrong-card{border-color:#FF6B6B;background:#fff5f5}
.rt{display:inline-flex;align-items:center;gap:6px;font-size:11.5px;font-weight:900;border-radius:999px;padding:3px 9px;margin-top:7px;}
.rt.ok{background:#52C16A20;color:#2a9c4f}
.rt.no{background:#FF6B6B20;color:#cc2020}
.qh{display:flex;gap:9px;align-items:flex-start}
.num{min-width:33px;height:33px;border-radius:9px;display:grid;place-items:center;font-family:'Baloo 2',sans-serif;font-size:14px;font-weight:900;flex-shrink:0;}
.nm{background:#4BB8F520;color:#1a8cd8}
.nt{background:#52C16A20;color:#2a9c4f}
.nf{background:#9B72CF20;color:#7b4fc9}
.no{background:#FF6B6B20;color:#cc2020}
.qb{flex:1}
.prompt{margin:0 0 8px;font-weight:800;font-size:13.5px;line-height:1.45}
.opts{display:grid;gap:4px}
.opt{display:flex;align-items:center;gap:8px;padding:6px 11px;border-radius:9px;border:1.5px solid var(--line);
  cursor:pointer;transition:all .14s;font-size:13.5px;font-weight:700;background:#fff;}
.opt:hover{border-color:#4BB8F5;background:#4BB8F508}
.opt.opt-ok{border-color:#52C16A!important;background:#52C16A15!important}
.opt.opt-no{border-color:#FF6B6B!important;background:#FF6B6B15!important}
.opt input[type=radio]{accent-color:#4BB8F5;width:14px;height:14px}
.ai{width:100%;max-width:320px;padding:7px 11px;border-radius:9px;border:1.5px solid var(--line);
  font:700 13.5px 'Nunito',sans-serif;color:var(--ink);background:#FAFAFA;transition:border-color .15s;outline:none;}
.ai:focus{border-color:var(--purple);background:#fff}
.submitted .opt,.submitted .ai{pointer-events:none}
.submitted .ai{background:#f5f5f5}

/* Submit */
.submit-row{display:flex;justify-content:center;margin:28px 0 6px}
.btn-submit{background:linear-gradient(135deg,#52C16A,#2a9c4f);color:#fff;border:none;border-radius:16px;
  padding:14px 40px;cursor:pointer;font:900 16px 'Baloo 2',sans-serif;box-shadow:0 6px 24px #52C16A40;
  transition:all .2s;display:inline-flex;align-items:center;gap:10px;letter-spacing:.3px;}
.btn-submit:hover{transform:translateY(-2px);box-shadow:0 10px 30px #52C16A55}
.submit-note{text-align:center;color:var(--muted);font-size:13px;margin-top:6px}

/* Modal */
.overlay{position:fixed;inset:0;background:#000a;backdrop-filter:blur(5px);z-index:1000;display:flex;
  align-items:flex-start;justify-content:center;padding:16px;overflow-y:auto;opacity:0;pointer-events:none;transition:opacity .3s;}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:#fff;border-radius:28px;max-width:920px;width:100%;box-shadow:0 24px 80px #00000045;
  overflow:hidden;transform:translateY(50px) scale(.97);transition:transform .38s cubic-bezier(.22,1,.36,1);margin:auto;}
.overlay.open .modal{transform:translateY(0) scale(1)}
.m-hero{padding:28px 22px 20px;text-align:center;position:relative;overflow:hidden}
.m-hero::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,#1a2744,#2d3f70,#3d2060)}
.hi{position:relative;z-index:1}
.ring-wrap{display:inline-flex;align-items:center;justify-content:center;width:110px;height:110px;margin-bottom:12px;position:relative}
.ring-bg{position:absolute;inset:0;border-radius:50%;border:9px solid #ffffff18}
.ring-fill{position:absolute;inset:0;border-radius:50%;border:9px solid transparent;border-top-color:#FFD234;
  transform:rotate(-90deg);transition:transform 1.1s cubic-bezier(.4,0,.2,1);}
.ring-fill.q2{border-right-color:#FFD234}
.ring-fill.q3{border-right-color:#FFD234;border-bottom-color:#FFD234}
.ring-fill.full{border-color:#FFD234}
.snum{font-family:'Baloo 2',sans-serif;font-size:34px;font-weight:900;color:#FFD234;line-height:1}
.ssub{font-size:12px;color:#ffffff80;margin-top:2px}
.m-hero h2{font-family:'Baloo 2',sans-serif;font-size:21px;font-weight:900;color:#fff;margin-bottom:5px}
.m-hero p{font-size:13.5px;color:#ffffffa0;margin-bottom:12px}
.gpills{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.gpill{display:inline-flex;align-items:center;gap:5px;background:#ffffff20;border:1px solid #ffffff30;border-radius:999px;
  padding:5px 13px;font-size:12px;font-weight:800;color:#fff}
.share-bar{padding:14px 18px;background:#f8f9fc;border-bottom:1px solid var(--line);display:flex;gap:8px;
  flex-wrap:wrap;align-items:center;justify-content:center}
.share-title{font-weight:900;font-size:13.5px;color:var(--navy);width:100%;text-align:center;margin-bottom:2px}
.sbtn{display:inline-flex;align-items:center;gap:7px;padding:9px 17px;border-radius:12px;font:800 13px 'Nunito',sans-serif;
  cursor:pointer;border:2px solid transparent;transition:all .18s;text-decoration:none;white-space:nowrap}
.se{background:#1a2744;color:#fff}.se:hover{background:#2d3f70;transform:translateY(-1px)}
.ss{background:#52C16A;color:#fff}.ss:hover{background:#3db058;transform:translateY(-1px)}
.sw{background:#25D366;color:#fff}.sw:hover{background:#1da851;transform:translateY(-1px)}
.sc{background:#fff;color:var(--navy);border-color:var(--line)}.sc:hover{border-color:var(--purple);color:var(--purple)}
.r-body{padding:18px 18px;max-height:52vh;overflow-y:auto}
.r-body h3{font-family:'Baloo 2',sans-serif;font-size:15px;color:var(--navy);margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--line)}
.ri{display:flex;gap:9px;align-items:flex-start;padding:8px 0;border-bottom:1px solid #f2f2f2}
.ri:last-child{border:none}
.ri-n{min-width:28px;height:28px;border-radius:8px;display:grid;place-items:center;font-family:'Baloo 2',sans-serif;font-size:12px;font-weight:900;flex-shrink:0}
.rio{background:#52C16A20;color:#2a9c4f}.rix{background:#FF6B6B20;color:#cc2020}.rio-open{background:#FFD23430;color:#886600}
.ri-b{flex:1;font-size:12.5px}
.ri-q{font-weight:900;color:var(--ink);margin-bottom:2px}
.ri-g{color:var(--muted)}
.ri-c{color:#2a9c4f;font-weight:900;margin-top:2px}
.ri-op{color:#886600;font-weight:900;margin-top:2px}
.m-foot{padding:12px 18px;background:#f8f9fc;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
.btn-close{background:#fff;color:var(--navy);border:2px solid var(--line);border-radius:12px;padding:9px 18px;font:800 13px 'Nunito',sans-serif;cursor:pointer}
.btn-close:hover{border-color:var(--coral);color:var(--coral)}
.btn-retake{background:linear-gradient(135deg,#4BB8F5,#1a8cd8);color:#fff;border:none;border-radius:12px;padding:9px 20px;font:800 13px 'Nunito',sans-serif;cursor:pointer}
.btn-retake:hover{transform:translateY(-1px);box-shadow:0 4px 14px #4BB8F540}
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}
@media print{.builder,.controls,.submit-row,.overlay,button{display:none!important}body{font-size:10.5pt}.q{break-inside:avoid}.exam-header{-webkit-print-color-adjust:exact;print-color-adjust:exact}}
</style>
</head>

<body>
<div class="page">

  <!-- BUILDER -->
  <div class="builder" id="builder">
    <h1>üß© CSV ‚Üí Exam Builder (Single HTML Template)</h1>
    <div class="row">
      <span class="small">
        1) Paste CSV below OR upload a .csv file. 2) Click ‚ÄúBuild Exam‚Äù.<br/>
        Required columns: <b>id, section, type, prompt</b>. For MC include <b>optA..optD</b> + <b>correct</b>.
      </span>
    </div>
    <div class="row">
      <input class="file" type="file" id="csvFile" accept=".csv"/>
      <button class="btn btn-ghost" id="btnLoadSample">üß™ Load sample</button>
      <button class="btn btn-warn" id="btnClearCsv">üóëÔ∏è Clear CSV</button>
      <button class="btn btn-primary" id="btnBuild">‚öôÔ∏è Build Exam</button>
    </div>
    <textarea class="ta" id="csvText" placeholder="Paste CSV here..."></textarea>
    <div class="row small">
      Tip: type can be mc / tf / fi / open. For tf correct should be true/false.
    </div>
  </div>

  <!-- EXAM -->
  <div id="examWrap" style="display:none">
    <div class="exam-header">
      <div>
        <div class="h-title" id="examTitle">üéì Exam</div>
        <div class="h-sub" id="examSubtitle">Practice test generated from CSV</div>
        <div class="badge-row" id="badgeRow"></div>
        <div class="name-row">
          <label>Name:</label><input id="nameInput" type="text" placeholder="Write your name‚Ä¶">
          <label>Date:</label><input id="dateInput" type="text" placeholder="Date‚Ä¶">
        </div>
      </div>
      <div class="info-boxes">
        <div class="info-box"><span class="val" id="qCount">0</span><span class="lbl">Questions</span></div>
        <div class="info-box"><span class="val" id="secCount">0</span><span class="lbl">Parts</span></div>
        <div class="info-box"><span class="val" id="answeredLive">0</span><span class="lbl">Answered</span></div>
      </div>
    </div>

    <div class="controls">
      <div>
        <div class="pb-wrap"><div class="pb" id="pb"></div></div>
        <div class="pb-lbl" id="pblbl">0 answered</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-ghost" onclick="window.print()">üñ®Ô∏è Print</button>
        <button class="btn btn-ghost" id="btnBack">‚¨ÖÔ∏è Back to CSV</button>
        <button class="btn btn-warn" onclick="clearAll()">üóëÔ∏è Clear</button>
      </div>
    </div>

    <div id="sections"></div>

    <div class="submit-row">
      <button class="btn-submit" onclick="submitExam()">‚úÖ Submit &amp; See My Results</button>
    </div>
    <p class="submit-note">Auto-marked questions will be graded. Open-ended questions show a model answer.</p>
    <p class="footer" id="footerText">Generated from CSV</p>
  </div>
</div>

<!-- RESULTS MODAL -->
<div class="overlay" id="overlay" onclick="outsideClick(event)">
  <div class="modal">
    <div class="m-hero">
      <div class="hi">
        <div class="ring-wrap">
          <div class="ring-bg"></div>
          <div class="ring-fill" id="ringFill"></div>
          <div style="text-align:center">
            <div class="snum" id="heroScore">‚Äî</div>
            <div class="ssub" id="heroOutOf">out of ‚Äî</div>
          </div>
        </div>
        <h2 id="heroTitle">Results</h2>
        <p id="heroMsg"></p>
        <div class="gpills" id="gpills"></div>
      </div>
    </div>
    <div class="share-bar">
      <div class="share-title">üì§ Share These Results</div>
      <a class="sbtn se" id="btnEmail" href="#">‚úâÔ∏è Email</a>
      <a class="sbtn ss" id="btnSms" href="#">üí¨ Message</a>
      <a class="sbtn sw" id="btnWa" href="#" target="_blank">üì± WhatsApp</a>
      <button class="sbtn sc" onclick="copyText()">üìã Copy</button>
    </div>
    <div class="r-body">
      <h3>üìù Full Breakdown</h3>
      <div id="rList"></div>
    </div>
    <div class="m-foot">
      <button class="btn-close" onclick="closeModal()">‚úñ Close</button>
      <button class="btn-retake" onclick="retake()">üîÑ Retake</button>
    </div>
  </div>
</div>

<script>
/* =========================
   1) CSV PARSING (safe-ish)
   ========================= */
function parseCSV(text){
  // Handles commas + quoted fields (basic, single-line rows)
  const rows=[];
  let i=0, field='', row=[], inQ=false;
  const pushField=()=>{row.push(field); field='';};
  const pushRow=()=>{rows.push(row); row=[];};

  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c === '"'){
        if(text[i+1] === '"'){ field+='"'; i++; }
        else inQ=false;
      } else field+=c;
    } else {
      if(c === '"') inQ=true;
      else if(c === ',') pushField();
      else if(c === '\n'){ pushField(); pushRow(); }
      else if(c === '\r'){ /* ignore */ }
      else field+=c;
    }
    i++;
  }
  // last row
  if(field.length || row.length){ pushField(); pushRow(); }
  // remove empty trailing rows
  return rows.filter(r => r.some(x => (x||'').trim() !== ''));
}

function csvToObjects(csvText){
  const rows=parseCSV(csvText.trim());
  if(!rows.length) return [];
  const header=rows[0].map(h=>h.trim());
  const out=[];
  for(let r=1;r<rows.length;r++){
    const obj={};
    header.forEach((h,idx)=>obj[h]= (rows[r][idx]??'').toString().trim());
    out.push(obj);
  }
  return out;
}

/* =========================
   2) EXAM DATA STRUCTURES
   ========================= */
let QUESTIONS=[];     // array of {id, section, type, prompt, options[], correct, explain, tags}
let AK={};            // answer key by id
let TOTAL=0;
let _shareText='';

const TYPE_META = {
  mc:  {title:'Part ‚Äî Multiple Choice', icon:'üîµ', sh:'sh-mc', hint:'‚úèÔ∏è Tick the correct answer.'},
  tf:  {title:'Part ‚Äî True or False',   icon:'‚úÖ', sh:'sh-tf', hint:'‚úèÔ∏è Type True or False.'},
  fi:  {title:'Part ‚Äî Fill in the Blanks', icon:'üü£', sh:'sh-fi', hint:'‚úèÔ∏è Type the missing answer.'},
  open:{title:'Part ‚Äî Open Questions',  icon:'üî¥', sh:'sh-op', hint:'‚úèÔ∏è Write your answer (not auto-marked).'}
};

function normalizeType(t){
  const v=(t||'').toLowerCase().trim();
  if(['mc','tf','fi','open'].includes(v)) return v;
  return 'open';
}

function buildFromCSV(csvText){
  const raw=csvToObjects(csvText);
  if(!raw.length) throw new Error('CSV has no rows.');

  // map rows ‚Üí questions
  const qs=[];
  for(const r of raw){
    const id=(r.id||'').trim();
    if(!id) continue;
    const type=normalizeType(r.type);
    const section=(r.section||'').trim() || 'A';
    const prompt=(r.prompt||'').trim();
    if(!prompt) continue;

    const optA=(r.optA||'').trim(), optB=(r.optB||'').trim(), optC=(r.optC||'').trim(), optD=(r.optD||'').trim();
    const options = (type==='mc') ? [optA,optB,optC,optD].filter(x=>x!== '') : [];
    const correct=(r.correct||'').trim();
    const explain=(r.explain||'').trim();
    const tags=(r.tags||'').trim();

    qs.push({id, section, type, prompt, options, correct, explain, tags});
  }

  // sort by numeric id
  qs.sort((a,b)=>Number(a.id)-Number(b.id));

  // build answer key
  const ak={};
  for(const q of qs){
    let c=null;
    if(q.type==='open') c=null;
    else c=(q.correct||'').trim();
    ak[q.id]={
      label:q.prompt,
      type:q.type,
      section:q.section,
      correct:c,
      explain:q.explain,
      // for MC show "B) something"
      correctLabel: (q.type==='mc' && c) ? `${c}) ${q.options['ABCD'.indexOf(c)] || ''}` :
                    (q.type==='tf' && c) ? (c.toLowerCase()==='true'?'True':'False') :
                    (q.type==='fi' && c) ? c :
                    (q.type==='open' ? (q.correct||q.explain||'') : c)
    };
  }

  QUESTIONS=qs;
  AK=ak;
  TOTAL=qs.length;
}

/* =========================
   3) RENDER EXAM
   ========================= */
function esc(s){
  return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

function makeBadges(){
  const bag=new Set();
  QUESTIONS.forEach(q=>{
    if(q.tags){
      q.tags.split('|').map(x=>x.trim()).filter(Boolean).forEach(t=>bag.add(t));
    }
  });
  const row=document.getElementById('badgeRow');
  row.innerHTML='';
  Array.from(bag).slice(0,10).forEach(t=>{
    const s=document.createElement('span');
    s.className='badge';
    s.textContent='üè∑Ô∏è '+t;
    row.appendChild(s);
  });
}

function sectionTitle(section, type){
  // ‚ÄúPart A ‚Äì Multiple Choice‚Äù
  const letter=section || '?';
  const meta=TYPE_META[type] || TYPE_META.open;
  const typeName = (type==='mc'?'Multiple Choice' : type==='tf'?'True or False' : type==='fi'?'Fill in the Blanks' : 'Open Questions');
  return `${meta.icon} Part ${letter} ‚Äì ${typeName}`;
}

function renderExam(){
  document.getElementById('examWrap').style.display='';
  document.getElementById('builder').style.display='none';

  document.getElementById('qCount').textContent=String(TOTAL);
  const secSet=new Set(QUESTIONS.map(q=>q.section));
  document.getElementById('secCount').textContent=String(secSet.size);

  makeBadges();

  const sectionsEl=document.getElementById('sections');
  sectionsEl.innerHTML='';

  // group by section then by type
  const bySection={};
  QUESTIONS.forEach(q=>{
    if(!bySection[q.section]) bySection[q.section]=[];
    bySection[q.section].push(q);
  });

  // stable section order A,B,C... then others
  const secOrder=Object.keys(bySection).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));

  secOrder.forEach(sec=>{
    const items=bySection[sec];

    // group by type in a nice order
    const order=['mc','tf','fi','open'];
    order.forEach(type=>{
      const qlist=items.filter(x=>x.type===type);
      if(!qlist.length) return;

      const meta=TYPE_META[type] || TYPE_META.open;
      const wrap=document.createElement('div');
      wrap.className='section';

      const head=document.createElement('div');
      head.className='sh '+meta.sh;
      const tag=document.createElement('span');
      tag.className='tag';
      tag.textContent=`${qlist.length} Qs`;
      head.innerHTML = `<span>${meta.icon}</span> ${esc(sectionTitle(sec,type))}`;
      head.appendChild(tag);

      const hint=document.createElement('p');
      hint.className='hint';
      hint.textContent=meta.hint;

      const grid=document.createElement('div');
      grid.className = (type==='open') ? 'grid' : 'grid two';

      qlist.forEach(q=>{
        const card=document.createElement('div');
        card.className=`q ${q.type}`;
        card.dataset.q=q.id;
        card.dataset.type=q.type;
        if(q.type!=='open') card.dataset.correct=(q.correct||'').trim();

        const numClass = q.type==='mc'?'nm' : q.type==='tf'?'nt' : q.type==='fi'?'nf' : 'no';
        const numHtml = `<div class="num ${numClass}">${esc(q.id)}</div>`;
        let body = `<p class="prompt">${esc(q.prompt)}</p>`;

        if(q.type==='mc'){
          const letters=['A','B','C','D'];
          const opts = q.options.slice(0,4);
          const optsHtml = opts.map((t,i)=>`
            <label class="opt">
              <input type="radio" name="q${esc(q.id)}" value="${letters[i]}"> ${letters[i]}) ${esc(t)}
            </label>
          `).join('');
          body += `<div class="opts">${optsHtml}</div>`;
        } else {
          body += `<input class="ai" type="text" placeholder="${q.type==='tf'?'True / False':'Type your answer‚Ä¶'}">`;
        }

        card.innerHTML = `
          <div class="qh">
            ${numHtml}
            <div class="qb">
              ${q.tags ? `<div style="font-size:11.5px;color:var(--muted);font-weight:900;margin-bottom:6px">üè∑Ô∏è ${esc(q.tags.replaceAll('|',', '))}</div>` : ''}
              ${body}
            </div>
          </div>
        `;
        grid.appendChild(card);
      });

      wrap.appendChild(head);
      wrap.appendChild(hint);
      wrap.appendChild(grid);
      sectionsEl.appendChild(wrap);
    });
  });

  // input listeners
  document.querySelectorAll('#examWrap input').forEach(i=>{
    i.addEventListener('change',updateProgress);
    i.addEventListener('input',updateProgress);
  });

  updateProgress();
}

document.getElementById('btnBack').addEventListener('click',()=>{
  document.getElementById('examWrap').style.display='none';
  document.getElementById('builder').style.display='';
  closeModal();
});

/* =========================
   4) PROGRESS + COLLECT
   ========================= */
function updateProgress(){
  const rg={};
  document.querySelectorAll('#examWrap input[type=radio]').forEach(r=>{
    if(!rg[r.name]) rg[r.name]=false;
    if(r.checked) rg[r.name]=true;
  });
  let n=Object.values(rg).filter(Boolean).length;
  document.querySelectorAll('#examWrap input[type=text]').forEach(t=>{ if(t.value.trim()) n++; });

  const p = TOTAL ? Math.min(100,Math.round(n/TOTAL*100)) : 0;
  document.getElementById('pb').style.width=p+'%';
  document.getElementById('pblbl').textContent=`${n} / ${TOTAL} answered`;
  document.getElementById('answeredLive').textContent=String(n);
}

function collect(){
  const a={};
  document.querySelectorAll('#examWrap .q').forEach(c=>{
    const q=c.dataset.q;
    if(!q) return;
    const type=c.dataset.type;
    if(type==='mc'){
      const s=c.querySelector('input[type=radio]:checked');
      a[q]=s?s.value:'';
    } else {
      const i=c.querySelector('input[type=text]');
      a[q]=i?i.value.trim():'';
    }
  });
  return a;
}

/* =========================
   5) GRADING + RESULTS
   ========================= */
function grade(ans){
  let score=0, maxAuto=0;
  const res={};
  Object.entries(AK).forEach(([qid,d])=>{
    const given=(ans[qid]||'').toString().trim();
    let ok=false, open=false;
    if(d.correct===null || d.type==='open'){ open=true; }
    else {
      maxAuto++;
      ok = given.toLowerCase() === d.correct.toLowerCase();
      if(ok) score++;
    }
    res[qid]={given, ok, open, label:d.label, correctLabel:d.correctLabel, explain:d.explain, correct:d.correct, type:d.type};
  });
  return {score,maxAuto,res};
}

function submitExam(){
  const name=document.getElementById('nameInput').value.trim()||'Student';
  const date=document.getElementById('dateInput').value.trim()||(new Date().toLocaleDateString());

  const ans=collect();
  const {score,maxAuto,res}=grade(ans);
  const pct = maxAuto ? Math.round(score/maxAuto*100) : 0;

  // lock inputs
  document.getElementById('examWrap').classList.add('submitted');

  // highlight cards
  Object.entries(res).forEach(([qid,r])=>{
    const card=document.querySelector(`#examWrap .q[data-q="${qid}"]`);
    if(!card || r.open) return;

    card.classList.add(r.ok?'correct-card':'wrong-card');

    if(card.dataset.type==='mc'){
      card.querySelectorAll('.opt').forEach(o=>{
        const radio=o.querySelector('input[type=radio]');
        if(!radio) return;
        if(radio.value===card.dataset.correct) o.classList.add('opt-ok');
        if(radio.checked && radio.value!==card.dataset.correct) o.classList.add('opt-no');
      });
    }

    const tag=document.createElement('div');
    tag.className='rt '+(r.ok?'ok':'no');
    tag.textContent = r.ok ? '‚úÖ Correct' : ('‚ùå Correct: ' + (r.correctLabel||''));
    card.querySelector('.qb').appendChild(tag);
  });

  // hero
  document.getElementById('heroScore').textContent=String(score);
  document.getElementById('heroOutOf').textContent=`out of ${maxAuto}`;

  const ht=document.getElementById('heroTitle');
  const hm=document.getElementById('heroMsg');
  if(pct>=90){ht.textContent=`üåü Outstanding, ${name}!`;hm.textContent='Incredible score ‚Äî nearly perfect!';}
  else if(pct>=75){ht.textContent=`üéâ Great work, ${name}!`;hm.textContent='Excellent effort ‚Äî well done!';}
  else if(pct>=50){ht.textContent=`üëç Good effort, ${name}!`;hm.textContent='You‚Äôre getting there ‚Äî review the ones you missed.';}
  else{ht.textContent=`üí™ Keep practising, ${name}!`;hm.textContent='Review your notes and try again ‚Äî every attempt helps!';}

  // ring
  const ring=document.getElementById('ringFill');
  const deg=pct/100*360;
  ring.classList.remove('q2','q3','full');
  if(deg>270) ring.classList.add('full');
  else if(deg>180) ring.classList.add('q3');
  else if(deg>90) ring.classList.add('q2');
  setTimeout(()=>{ ring.style.transform=`rotate(${deg-90}deg)`; },150);

  // pills
  const pills=document.getElementById('gpills');
  pills.innerHTML='';
  [
    {i:'üìä', t:`${score}/${maxAuto} auto-marked`},
    {i:'‚úçÔ∏è', t:`${TOTAL-maxAuto} open`},
    {i:'üéØ', t:`${pct}% accuracy`},
    {i:'üìÖ', t:date}
  ].forEach(p=>{
    const s=document.createElement('span');
    s.className='gpill';
    s.textContent=`${p.i} ${p.t}`;
    pills.appendChild(s);
  });

  // list
  const list=document.getElementById('rList');
  list.innerHTML='';
  Object.entries(res).forEach(([qid,r])=>{
    const d=document.createElement('div'); d.className='ri';
    const n=document.createElement('div');
    n.className='ri-n '+(r.open?'rio-open':(r.ok?'rio':'rix'));
    n.textContent=qid;

    const b=document.createElement('div'); b.className='ri-b';
    b.innerHTML = `
      <div class="ri-q">Q${esc(qid)}: ${esc(r.label)}</div>
      <div class="ri-g">Your answer: ${esc(r.given||'(blank)')}</div>
    `;

    if(r.open){
      const ca=document.createElement('div'); ca.className='ri-op';
      const model = r.correctLabel || r.explain || '‚Äî';
      ca.textContent = 'üìù Model: ' + model;
      b.appendChild(ca);
    } else if(!r.ok){
      const ca=document.createElement('div'); ca.className='ri-c';
      ca.textContent = '‚úÖ Correct: ' + (r.correctLabel||'');
      b.appendChild(ca);
    }

    if(r.explain){
      const ex=document.createElement('div');
      ex.className='ri-g';
      ex.style.marginTop='4px';
      ex.textContent='Note: ' + r.explain;
      b.appendChild(ex);
    }

    d.appendChild(n); d.appendChild(b);
    list.appendChild(d);
  });

  // share text
  const wrong = Object.entries(res).filter(([,r])=>!r.open && !r.ok).map(([q])=>'Q'+q);
  _shareText = `üìö Exam Results\nüë§ ${name}\nüìÖ ${date}\n‚úÖ Score: ${score}/${maxAuto} (${pct}%)\n`;
  if(wrong.length) _shareText += `\nüìù Review: ${wrong.slice(0,25).join(', ')}${wrong.length>25?' ‚Ä¶':''}\n`;
  _shareText += `\nüîó ${window.location.href}`;

  const enc=encodeURIComponent(_shareText);
  const subj=encodeURIComponent(`Exam Results ‚Äî ${name}`);
  document.getElementById('btnEmail').href=`mailto:?subject=${subj}&body=${encodeURIComponent(_shareText)}`;
  document.getElementById('btnSms').href=`sms:?body=${enc}`;
  document.getElementById('btnWa').href=`https://wa.me/?text=${enc}`;

  document.getElementById('overlay').classList.add('open');
  document.body.style.overflow='hidden';
}

function closeModal(){document.getElementById('overlay').classList.remove('open');document.body.style.overflow='';}
function outsideClick(e){if(e.target===document.getElementById('overlay'))closeModal();}
function retake(){ if(confirm('Clear all answers and retake?')){ closeModal(); clearAll(); } }

function copyText(){
  if(!_shareText) return;
  const btn=document.querySelector('.sc');
  if(navigator.clipboard){
    navigator.clipboard.writeText(_shareText).then(()=>{
      btn.textContent='‚úÖ Copied!';
      setTimeout(()=>btn.textContent='üìã Copy',2000);
    });
  } else {
    const ta=document.createElement('textarea');
    ta.value=_shareText; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    btn.textContent='‚úÖ Copied!';
    setTimeout(()=>btn.textContent='üìã Copy',2000);
  }
}

function clearAll(){
  document.querySelectorAll('#examWrap input[type=text]').forEach(i=>i.value='');
  document.querySelectorAll('#examWrap input[type=radio]').forEach(r=>r.checked=false);
  document.querySelectorAll('#examWrap .q').forEach(c=>{
    c.classList.remove('correct-card','wrong-card');
    c.querySelectorAll('.opt').forEach(o=>o.classList.remove('opt-ok','opt-no'));
    c.querySelectorAll('.rt').forEach(t=>t.remove());
  });
  document.getElementById('examWrap').classList.remove('submitted');
  _shareText='';
  updateProgress();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* =========================
   6) UI: LOAD FILE / BUILD
   ========================= */
const sampleCSV = `id,section,type,prompt,optA,optB,optC,optD,correct,explain,tags
1,A,mc,Which number is a multiple of 7?,27,42,45,50,B,,Multiples
2,A,mc,What is 47 √ó 3?,141,131,144,137,A,,Multiplication
3,B,tf,49 is a multiple of 7.,,,,,,true,,Multiples
4,C,fi,7 √ó ? = 56.,,,,,,8,,Times tables
5,E,open,List all factor pairs of 36.,,,,,,,1√ó36, 2√ó18, 3√ó12, 4√ó9, 6√ó6,Factors
`;

document.getElementById('btnLoadSample').addEventListener('click',()=>{
  document.getElementById('csvText').value = sampleCSV;
});

document.getElementById('btnClearCsv').addEventListener('click',()=>{
  document.getElementById('csvText').value = '';
});

document.getElementById('csvFile').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0];
  if(!f) return;
  const text=await f.text();
  document.getElementById('csvText').value = text;
});

document.getElementById('btnBuild').addEventListener('click',()=>{
  const txt=document.getElementById('csvText').value.trim();
  if(!txt){ alert('Paste CSV (or load a file) first.'); return; }
  try{
    buildFromCSV(txt);
    // Basic title tweak based on sections count
    document.getElementById('examTitle').textContent = `üéì Exam ‚Äî ${TOTAL} Questions`;
    document.getElementById('examSubtitle').textContent = `Generated from CSV ¬∑ Auto-marking for MC/TF/FI`;
    document.getElementById('footerText').textContent = `Generated from CSV ¬∑ Total questions: ${TOTAL}`;
    renderExam();
  }catch(err){
    alert('CSV error: ' + err.message);
  }
});
</script>
</body>
</html>